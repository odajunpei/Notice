{"filter":false,"title":"vision.rb","tooltip":"/notice/lib/vision.rb","undoManager":{"mark":8,"position":8,"stack":[[{"start":{"row":0,"column":0},"end":{"row":43,"column":3},"action":"insert","lines":["require 'base64'","require 'json'","require 'net/https'","","module Vision","  class << self","    def get_image_data(image_file)","      # APIのURL作成","      api_url = \"https://vision.googleapis.com/v1/images:annotate?key=#{ENV['GOOGLE_API_KEY']}\"","","      # 画像をbase64にエンコード","      base64_image = Base64.encode64(open(\"#{Rails.root}/public/uploads/#{image_file.id}\").read)","","      # APIリクエスト用のJSONパラメータ","      params = {","        requests: [{","          image: {","            content: base64_image","          },","          features: [","            {","              type: 'LABEL_DETECTION'","            }","          ]","        }]","      }.to_json","","      # Google Cloud Vision APIにリクエスト","      uri = URI.parse(api_url)","      https = Net::HTTP.new(uri.host, uri.port)","      https.use_ssl = true","      request = Net::HTTP::Post.new(uri.request_uri)","      request['Content-Type'] = 'application/json'","      response = https.request(request, params)","      response_body = JSON.parse(response.body)","      # APIレスポンス出力","      if (error = response_body['responses'][0]['error']).present?","        raise error['message']","      else","        response_body['responses'][0]['labelAnnotations'].pluck('description').take(3)","      end","    end","  end","end"],"id":1}],[{"start":{"row":21,"column":25},"end":{"row":21,"column":26},"action":"remove","lines":["L"],"id":2},{"start":{"row":21,"column":24},"end":{"row":21,"column":25},"action":"remove","lines":["E"]},{"start":{"row":21,"column":23},"end":{"row":21,"column":24},"action":"remove","lines":["B"]},{"start":{"row":21,"column":22},"end":{"row":21,"column":23},"action":"remove","lines":["A"]},{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"remove","lines":["L"]}],[{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"insert","lines":["F"],"id":3},{"start":{"row":21,"column":22},"end":{"row":21,"column":23},"action":"insert","lines":["A"]},{"start":{"row":21,"column":23},"end":{"row":21,"column":24},"action":"insert","lines":["C"]},{"start":{"row":21,"column":24},"end":{"row":21,"column":25},"action":"insert","lines":["E"]}],[{"start":{"row":21,"column":24},"end":{"row":21,"column":25},"action":"remove","lines":["E"],"id":4},{"start":{"row":21,"column":23},"end":{"row":21,"column":24},"action":"remove","lines":["C"]},{"start":{"row":21,"column":22},"end":{"row":21,"column":23},"action":"remove","lines":["A"]},{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"remove","lines":["F"]}],[{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"insert","lines":["l"],"id":5},{"start":{"row":21,"column":22},"end":{"row":21,"column":23},"action":"insert","lines":["a"]},{"start":{"row":21,"column":23},"end":{"row":21,"column":24},"action":"insert","lines":["b"]},{"start":{"row":21,"column":24},"end":{"row":21,"column":25},"action":"insert","lines":["e"]},{"start":{"row":21,"column":25},"end":{"row":21,"column":26},"action":"insert","lines":["l"]}],[{"start":{"row":21,"column":25},"end":{"row":21,"column":26},"action":"remove","lines":["l"],"id":6},{"start":{"row":21,"column":24},"end":{"row":21,"column":25},"action":"remove","lines":["e"]},{"start":{"row":21,"column":23},"end":{"row":21,"column":24},"action":"remove","lines":["b"]},{"start":{"row":21,"column":22},"end":{"row":21,"column":23},"action":"remove","lines":["a"]},{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"remove","lines":["l"]}],[{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"insert","lines":["A"],"id":7}],[{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"remove","lines":["A"],"id":8}],[{"start":{"row":21,"column":21},"end":{"row":21,"column":22},"action":"insert","lines":["L"],"id":9},{"start":{"row":21,"column":22},"end":{"row":21,"column":23},"action":"insert","lines":["A"]},{"start":{"row":21,"column":23},"end":{"row":21,"column":24},"action":"insert","lines":["B"]},{"start":{"row":21,"column":24},"end":{"row":21,"column":25},"action":"insert","lines":["E"]},{"start":{"row":21,"column":25},"end":{"row":21,"column":26},"action":"insert","lines":["L"]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":43,"column":3},"end":{"row":43,"column":3},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1635829580028,"hash":"293b2df0341125320c255e0663f52d017beaaaaa"}